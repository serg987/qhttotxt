# qhttotxt - QIP history (.qhf, .ahf и .txt) конвертер и объединитель то .txt #

### Предыстория ###
В конце нулевых — начале десятых годов широкое распространение получил мессенджер QIP, работающий по протоколу ICQ. 
У мессенджера также имелась версия для мобильных устройств - QIP PDA. В отличие от остальных мессенджеров, 
хранящих историю в текстовых файлах, QIP хранил ее во внутренних форматах: .qhf и .ahf. При этом, QIP для PC также еще и 
шифровал историю. Кроме того, как и большинство мессенджеров того времени, между разными устройствами не было 
синхронизации, поэтому вполне вероятна ситуация, когда сообщения одного и того же контакта находятся в разных местах. 
Также, если на устройстве была папка "Archive" с .ahf файлами, то сообщения одного контакта также будут находиться в 
разных файлах. И в довершении ко всему, история может хранится в обычных txt файлах от таких мессенджеров, как Mchat, 
к примеру. Или уже была перековертирована сторонними программами из ICQ, RnQ или того же QIP. Все это создает большую 
неразбериху и объединение историй требует больших усилий.

Для перевода истории QIP в текстовые файлы было разработано несколько программ, однако по состоянию на апрель 2021 года
они или недоступны в свободном доступе, или не работают на современных ОС. Во всяком случае, автору не удалось 
найти работающий вариант в свободном доступе.

### Краткое описание ###

qhttotxt - небольшая программа, работающая на Java, которая позволяет сконвертировать файлы внутреннего формата истории 
QIP (.qhf и .ahf) в удобные к просмотру и поиску .txt файлы. Программа может объединять сообщения из разных файлов для 
одного контакта, в версии 1.0a также собрать историю из текстовых файлов и незашифрованных контакт-листов (файлы .cl 
и .cbd), выбрав уникальные сообщения, и поставив их в соответствии со временем отправки/получения.

Также реализованы минимальные возможности для восстановления испорченных сообщений и файлов. Однако у автора нет 
большого количества файлов для теста, поэтому, вполне вероятно, что в некоторых испорченных файлах будут пропавшие
сообщения.

### Использование ### 
Для использования программы необходима установка JAVA JDK версии не ниже 1.8. 

Простейший вариант:
Скачайте файл /jars/qhftotxt.jar из данного репозитория и положите в папку, где хранится история сообщений. Запустите 
программу без ключей:

`> java -jar qhttotxt.jar`

Программа найдет все возможные файлы в данной папке и переконвертирует их.

Расширенные возможности доступны с использованием параметров (могут идти в любом порядке):

`{путь}` - задание пути директории с файлами или пути к одному файлу. Поддерживается только один путь.
Если нужно сконвертировать несколько папок, разместите их в одной корневой. Используйте ключ `-r` и укажите путь к 
корневой папке.

`-с` - объединение сообщений от одного контакта. Если задан ключ `-r`, то выходные файлы будут размещены в рабочей 
директории. Объединяются только уникальные сообщения, все дубликаты удаляются. При задании ключа `-c` также будет 
произведена попытка найти txt файлы в формате QIP/ICQ, Mchat и RnQ (описание форматов смотри ниже, также как и 
**важное** требование к их именам). Также будет произведена попытка найти файлы контакт-листов .cl и .cbd, объединить 
их и записать в один. Из контакт-листов используются только uinы, никнеймы и группы. 

`-h` - краткая справка.

`-n {nickname}` - в файлах истории отсутствуют данные о нике или UIN владельца, поэтому восстановить его из файлов 
невозможно. Если ник не задан этим ключом, то он по умолчанию в текстах будет 'You'.

`-p {codepage}` - принудительное задание страницы кодировки. Если программа запускается на компьютере, на котором нет 
языка файлов истории, этот ключ может помочь (в выходных файлах кракозябры). Кодировка должна быть задана в стандартном 
формате. См подробнее https://en.wikipedia.org/wiki/Code_page.

`-r` - рекурсивный поиск в поддиректориях рабочего директория. По умолчанию рекурсивный поиск выключен. При рекурсивном 
поиске выходные файлы размещаются в тех же директориях, что и оригинальные.

`-z {timezone}` - принудительное задание часового пояса для отображения времени сообщений. Если на компьютере, где 
запускается программа, задан часовой пояс, отличный от того, в котором происходила запись истории, то время в выходных 
файлах будет указано неверно. Часовой пояс должен быть задан в стандартном формате. См подробнее 
https://en.wikipedia.org/wiki/List_of_tz_database_time_zones

Примеры:
Сконвертировать файлы в текущей (в том, в котором находится файл `qhttotxt.jar`) директории:

`> java -jar qhttotxt.jar`

Сконвертировать только файл `C:\Users\User\Documents\file.qhf` (файл `qhttotxt.jar` может быть в любом месте):

`> java -jar qhttotxt.jar C:\Users\User\Documents\file.qhf`

Сконвертировать файлы в `C:\Users\User\Documents` и всех поддиректориях, задать никнэйм "John Snow" и страницу 
кодировки "windows-1251" (стандартная для русского языка). файл `qhttotxt.jar` может быть в любом месте:

`> java -jar qhttotxt.jar -r -n "John Snow" -p "windows-1251" C:\Users\User\Documents`

Сконвертировать файлы в `C:\Users\User\Documents` и всех поддиректориях, объединить истории контактов из разных файлов, 
задать никнэйм "John Snow", страницу кодировки "windows-1251" (стандартная для русского языка), часовой пояс
"Europe/Moscow" (полный набор параметров) файл `qhttotxt.jar` может быть в любом месте:

`> java -jar qhttotxt.jar -c -n "John Snow" -p "windows-1251" -z "Europe/Moscow" -r C:\Users\User\Documents`

## Описание форматов текстовых файлов, распознаваемых программой ##

Если Ваши файлы похожи на форматы ниже, то qhftotxt постарается их прочитать и объединить с другими существующими
файлами. ВАЖНО! Имена чатов в txt формате должны быть в виде `{contact_uin}.txt`, т.е. `123456789.txt`. По имени,
и только по имени файла будет определяться, с кем ведется данный чат. Если имя файла не соответствует данному шаблону,
измените его вручную. Если несколько есть несколько файлов с одним именем, положите их в разные поддиректории и
используйте ключ `-r`.

### qip/icq: ###
``` 
{Начало файла}
-------------------------------------->- (разделитель, `<` - принятое сообщение, `>` - отправленное)
{Owner_nick} (21:48:51 18/08/2015)
message


--------------------------------------<-
{contact_nick} (14:28:50 19/10/2015)
Message


--------------------------------------<-
... 
```

### Mchat: ###
```
{Начало файла}
28.05.08 10:13:17<message
28.05.08 10:15:26>message
28.05.08 10:21:39<message
message str2
28.05.08 10:21:59>message
```
### RnQ (сконвертированный программой RnQHistoryReader) ###
```
{Начало файла}
Чат между {Owner_uin} и {contactUin}


13.10.2006 10:48:00 {contactUin}
message


13.10.2006 10:48:40 {Owner_uin}
message


13.10.2006 10:54:58 {contactUin}
message


```

## Описание формата QHF (AHF) ##

Оригинальное описание формата взято из https://github.com/MolinRE/QIParser. Без описания не было бы этой программы. 
Огромная благодарность автору и владельцу Константину Комарову (https://github.com/MolinRE) за разрешение 
использования также и в этом проекте. Также описание есть по ссылке 
https://alexey-m.ru/articles/qip-infium-prodolzhenie-istorii 

## Структура файла ##

### Заголовок файла ###

Заголовок содержит информацию о файле истории. Оттуда можно узнать размер истории (непонятно, зачем), количество 
сообщений (непонятно, почему оно идёт два раза), UIN и никнейм человека. Все числовые значения хранятся в `Big Endian` 
формате. Кодировка - `UTF8`.

Позиция | HEX | Размер | Описание
------------- | ------------- | ------------- | -------------
0 | 0x00 | Char(3) | Подпись. Всегда "QHF".
4 | 0x04 | Int32 | Размер истории (в байтах).
34 | 0x22 | Int32 | Количество сообщений.
38 | 0x26 | Int32 | ???
44 | 0x2C | Int16 | Длина UIN.
46 | 0x2E | Char(N) | UIN. N = длина.
46 + N | 0x2E + N | Int16 | Длина ника.
48 + N | 0x30 + N | Char(N) | Никнейм. N = длина.

### Сообщения ###
После заголовка начинаются сообщения. Они идут подряд. Позиция отсчитывается после заголовка.

_Комментарии serg987: из анализа ~50 тыс. сообщений видно, что значения большинства полей 
всегда одни и те же (см. колонку "Значение")_ 

Позиция | HEX | Размер | Описание | _Значение_
------------- | ------------- | ------------- | -------------  | -------------
00 | 0x00 | Int16 | Подпись. Всегда равна 1. | 1
02 | 0x02 | Int32 | Размер блока с сообщением. (без первых 6 байт)
06 | 0x06 | Int16 | Тип поля (?) ID сообщения. | 1
08 | 0x08 | Int16 | Размер блока с ID сообщения. | 4
10 | 0x0A | Int32 | ID сообщения. Просто порядковый номер. 
14 | 0x0E | Int16 | Тип поля (?) даты отправки сообщения. | 2
16 | 0x10 | Int16 | Размер поля с датой отправки сообщения. | 4
18 | 0x12 | Int32 | Дата в UNIX-формате.
22 | 0x16 | Int16 | Тип поля ??? | 3
24 | 0x18 | Int16 | ??? | 3
26 | 0x1A | Byte | Является ли сообщение отправленным. Boolean.
27 | 0x1B | Int16 | Тип поля текста сообщения. | см табл. ниже
29 | 0x1D | Int16 | Размер блока, в котором хранится длина сообщения. _(1)_ | 4
31 | 0x1F | Int16/32 _(1)_ | Длинна сообщения в байтах.
35 | 0x23 | Byte(N) | Текст сообщения, _(не)_ закодированный. _(2)_

_Комментарии serg987:_

_(1) - Для файлов QIP PDA c незашифрованным текстом сообщений для длины используется Int16 (2 байта), а значение 
поля 0x1D - все равно 04. Это может быть баг, а может, что это поле — не размер блока, а какая-то другая константа._

_(2) - Для файлов QIP PDA текст сообщения не кодирован._

### Кодировка сообщения ###
_Комментарии serg987: неприменимо для файлов QIP PDA_

Текст сообщений хранится в кодировке UTF8, как было сказано ранее. Однако, прежде чем перевести байты в текст, их 
нужно декодировать. Декодирование байтов, из которых состоит текст сообщения, выполняется по следующему принципу:
```csharp
for (int i = 0; i < array.Length; i++)
    array[i] = (byte)(255 - array[i] - i - 1);
```

### Подробная справка по полям ###
Перед каждым блоком идёт идентификатор блока в виде 16-битного целого числа со знаком (или всё же unsigned?). Ниже 
приведена таблица, в которой более детально раскрыты возможные типы блоков.

_Комментарии serg987: по наблюдениям, поля типа 05, 13 и 14 дублируются соответствующей фразой в тексте сообщения_

Тип | Значение
------------- | -------------
01 | Сообщение, полученное пока аккаунт был в сети.
02 | Дата отправки сообщения.
03 | Отправитель сообщения.
05 | Запрос авторизации.
06 | Запрос на добавление в друзья.
13 | Сообщение, полученное пока аккаунт был вне сети.
14 | Запрос на авторизацию принят.
| | Добавлено serg987:
80 | Сервисные сообщения QIP/ICQ. Обычно о проблемах со связью
81 | Сервисные сообщения QIP/ICQ. Обычно о днях рождений контактов

### Лицензирование ###

Стандартная лицензия MIT
Copyright (c) 2021 Sergey Kiselev

Данная лицензия разрешает лицам, получившим копию данного программного обеспечения и сопутствующей документации 
(в дальнейшем именуемыми «Программное обеспечение»), безвозмездно использовать Программное обеспечение без ограничений, 
включая неограниченное право на использование, копирование, изменение, слияние, публикацию, распространение, 
сублицензирование и/или продажу копий Программного обеспечения, а также лицам, которым предоставляется данное 
Программное обеспечение, при соблюдении следующих условий:

Указанное выше уведомление об авторском праве и данные условия должны быть включены во все копии или значимые части 
данного Программного обеспечения.

ДАННОЕ ПРОГРАММНОЕ ОБЕСПЕЧЕНИЕ ПРЕДОСТАВЛЯЕТСЯ «КАК ЕСТЬ», БЕЗ КАКИХ-ЛИБО ГАРАНТИЙ, ЯВНО ВЫРАЖЕННЫХ ИЛИ ПОДРАЗУМЕВАЕМЫХ, 
ВКЛЮЧАЯ ГАРАНТИИ ТОВАРНОЙ ПРИГОДНОСТИ, СООТВЕТСТВИЯ ПО ЕГО КОНКРЕТНОМУ НАЗНАЧЕНИЮ И ОТСУТСТВИЯ НАРУШЕНИЙ, 
НО НЕ ОГРАНИЧИВАЯСЬ ИМИ. НИ В КАКОМ СЛУЧАЕ АВТОРЫ ИЛИ ПРАВООБЛАДАТЕЛИ НЕ НЕСУТ ОТВЕТСТВЕННОСТИ ПО КАКИМ-ЛИБО ИСКАМ, 
ЗА УЩЕРБ ИЛИ ПО ИНЫМ ТРЕБОВАНИЯМ, В ТОМ ЧИСЛЕ, ПРИ ДЕЙСТВИИ КОНТРАКТА, ДЕЛИКТЕ ИЛИ ИНОЙ СИТУАЦИИ, ВОЗНИКШИМ ИЗ-ЗА 
ИСПОЛЬЗОВАНИЯ ПРОГРАММНОГО ОБЕСПЕЧЕНИЯ ИЛИ ИНЫХ ДЕЙСТВИЙ С ПРОГРАММНЫМ ОБЕСПЕЧЕНИЕМ.
